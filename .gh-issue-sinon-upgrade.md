## Summary
Upgrade sinon test framework from 10.0.1 to latest stable version (21.0.0+) to benefit from bug fixes, security updates, and improved TypeScript support.

## Current Status
- Current version: sinon 10.0.1 (from 2021)
- Dependabot PR #107 proposed: sinon 21.0.0
- Testing revealed: **Breaking changes in test assertion APIs**

## Problem
Initial testing of sinon 21.0.0 (PR #107) revealed significant breaking changes:

### Test Failures
```
12 failing tests out of 22 total
- test/gpx.test.js: TypeError: Cannot read properties of undefined (reading 'equal')
- Multiple tests failing due to assertion API changes
```

### Breaking Changes (v10 â†’ v21)
Sinon went through 11 major versions with API changes:
- Assertion syntax changed
- Spy/stub API modifications
- Mock interface updates
- Integration with chai-sinon may need updates

## Tasks

### Phase 1: Research & Planning
- [ ] Review sinon v11-v21 migration guides
- [ ] Identify all breaking changes affecting our codebase
- [ ] Document new assertion patterns
- [ ] Check chai-sinon compatibility

### Phase 2: Update Test Files
- [ ] Update `test/activities.test.js` - Convert spy/stub assertions
- [ ] Update `test/auth.test.js` - Update authentication test mocks
- [ ] Update `test/errors.test.js` - Update error handling tests
- [ ] Update `test/gpx.test.js` - Fix assertion errors (critical)
- [ ] Update `test/health.test.js` - Update health check tests
- [ ] Update `test/routes.test.js` - Update route testing patterns

### Phase 3: Verification
- [ ] Run full test suite: `npm test`
- [ ] Verify all tests pass (22/22)
- [ ] Check for deprecation warnings
- [ ] Update any test utilities/helpers
- [ ] Document new patterns in test documentation

### Phase 4: Dependencies
- [ ] Verify chai-sinon compatibility with sinon 21
- [ ] Update chai-sinon if needed
- [ ] Check supertest integration
- [ ] Update any other test-related dependencies

## Acceptance Criteria
- All 22 tests passing with sinon 21.0.0
- No deprecation warnings
- Test assertion patterns documented
- CI/CD pipeline green
- No breaking changes in test behavior (same coverage)

## Migration Examples

### Old Syntax (sinon 10)
```javascript
const spy = sinon.spy();
spy();
expect(spy).to.have.been.called;
expect(spy).to.have.been.calledOnce;
expect(spy).to.have.been.calledWith('arg');
```

### New Syntax (sinon 21) - TBD
Research needed to document correct new patterns.

## Implementation Notes

### Common Patterns to Update
1. **Spy assertions**: `spy.calledWith()` vs `expect(spy).to.have.been.calledWith()`
2. **Stub behavior**: Check for `stub.returns()` vs `stub.resolves()` changes
3. **Mock expectations**: Verify mock verification methods
4. **Sinon-chai integration**: May need assertion library updates

### Test Files Breakdown
- `activities.test.js`: Activity creation, route distance calculation
- `auth.test.js`: Signup, login, token refresh, email verification
- `errors.test.js`: Error response format standardization
- `gpx.test.js`: GPX upload, analytics (highest failure rate)
- `health.test.js`: Health endpoint checks
- `routes.test.js`: Route API endpoints

## Risk Assessment
- **Risk Level**: Medium
- **Impact**: Test infrastructure only (no production code)
- **Effort**: 4-6 hours estimated
- **Dependencies**: May require chai-sinon upgrade

## Alternative Approach
If breaking changes too extensive:
- Consider alternative: Stay on sinon 10.x with security patches
- Or: Migrate to different test framework (jest, vitest)

## Related Issues
- Dependabot PR #107 (deferred)
- Part of test infrastructure improvements

## Notes
- Not blocking MVP development
- Can be done as tech debt cleanup
- Should be completed before adding more complex tests
- Consider pairing with test coverage improvements

## Epic
Not assigned - Tech Debt / Quality Improvements

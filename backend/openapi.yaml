openapi: 3.0.3
info:
  title: Tracksy API
  version: 1.0.0
  description: |
    Initial OpenAPI specification (skeleton) for Tracksy API.
    Current production endpoints are still mounted under /api/*.
    New evolution will occur under /api/v1/*.
servers:
  - url: http://localhost:3000
    description: Local development
tags:
  - name: auth
  - name: activity
  - name: health
  - name: admin
  - name: integrations
paths:
  /healthz:
    get:
      tags: [health]
      summary: Health check endpoint
      description: Returns service health status, uptime, and database connectivity (unauthenticated)
      responses:
        '200':
          description: Service is operational
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /signup:
    post:
      tags: [auth]
      summary: Create a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error or duplicate user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /login:
    post:
      tags: [auth]
      summary: Authenticate user and receive JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Successful authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activitylog:
    get:
      tags: [activity]
      summary: List activity logs for current user
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
        - in: query
          name: type
          schema: { type: string }
      responses:
        '200':
          description: List of activity logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityLog'
        '401':
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/healthmetrics:
    get:
      tags: [health]
      summary: List health metrics for current user
      responses:
        '200':
          description: List of health metrics
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/HealthMetric'
        '401':
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/admin/analytics:
    get:
      tags: [admin]
      summary: Platform analytics summary
      responses:
        '200':
          description: Analytics summary object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAnalytics'
        '401':
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    SignupRequest:
      type: object
      required: [username, password, email]
      properties:
        username: { type: string }
        password: { type: string, format: password }
        email: { type: string, format: email }
        role: { type: string }
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string }
        password: { type: string, format: password }
    AuthResponse:
      type: object
      properties:
        token: { type: string }
    ActivityLog:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        activityType: { type: string }
        duration: { type: number }
        deleted: { type: boolean }
    HealthMetric:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        metricType: { type: string }
        value: { type: number }
        deleted: { type: boolean }
    HealthResponse:
      type: object
      properties:
        status: 
          type: string
          enum: [ok, degraded]
        uptime: 
          type: number
          description: Process uptime in seconds
        timestamp: 
          type: string
          format: date-time
        database: 
          type: string
          enum: [connected, connecting, disconnected]
        version: 
          type: string
    AdminAnalytics:
      type: object
      properties:
        totalUsers: { type: integer }
        totalActivities: { type: integer }
        avgDuration: { type: number }
        popularActivity: { type: string }
        activeGoals: { type: integer }
        avgWaterIntake: { type: number }
    Error:
      type: object
      required: [error]
      description: |
        Standardized error response format used across all API endpoints.
        
        ## Common Error Codes
        
        ### Authentication & Authorization (401, 403)
        - `NO_TOKEN`: Missing authorization header
        - `INVALID_TOKEN`: JWT token is invalid or malformed
        - `TOKEN_EXPIRED`: JWT token has expired
        - `INVALID_CREDENTIALS`: Invalid username/password
        - `NOT_AUTHENTICATED`: Authentication required
        - `FORBIDDEN`: Insufficient permissions
        - `INVALID_REFRESH_TOKEN`: Refresh token is invalid or expired
        
        ### Validation Errors (400)
        - `VALIDATION_ERROR`: Request validation failed (check details array)
        - `INVALID_ID`: Invalid MongoDB ObjectId format
        - `INVALID_TIME_RANGE`: End time is before start time
        - `INVALID_ROUTE`: Route ID not found or invalid
        
        ### Resource Errors (404, 409)
        - `NOT_FOUND`: Resource not found
        - `DUPLICATE_USER`: Username or email already exists
        - `DUPLICATE_ENTRY`: Resource already exists
        - `FORBIDDEN_ROUTE`: User doesn't have access to this route
        
        ### Server Errors (500, 503)
        - `INTERNAL_ERROR`: Internal server error
        - `DATABASE_ERROR`: Database operation failed
        - `SERVICE_UNAVAILABLE`: Service is temporarily unavailable
      properties:
        error:
          type: object
          required: [message, code, statusCode, requestId]
          properties:
            message:
              type: string
              description: Human-readable error message
              example: "Validation failed"
            code:
              type: string
              description: Machine-readable error code for client handling
              example: "VALIDATION_ERROR"
            statusCode:
              type: integer
              description: HTTP status code
              example: 400
            requestId:
              type: string
              description: Unique request identifier for tracing
              example: "550e8400-e29b-41d4-a716-446655440000"
            details:
              type: array
              description: Optional array of detailed error information
              items:
                type: object
                properties:
                  field:
                    type: string
                    description: Field name that caused the error
                  message:
                    type: string
                    description: Specific error message for this field
              example:
                - field: "email"
                  message: "Invalid email format"
                - field: "password"
                  message: "Password must be at least 8 characters"
            stack:
              type: string
              description: Stack trace (only in development mode)
security:
  - bearerAuth: []